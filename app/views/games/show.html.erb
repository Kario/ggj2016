<script>
	var main_obj = <%= raw @riddles.to_json %>;
	var riddleAnswer = "CHEESE";
	var speechCapture = "";
	var attempts = 0;
	var correctAnswers = 0;
	
	createjs.Sound.registerSounds(
	[
	<% @riddles["scenarios"].each do |scenario| %>
		<% scenario["audio"].each do |audio| %>
			<% unless audio[1]["filename"].blank? %>
				{ id: "<%= audio[0].to_s %>", src: "<%= audio[1]["filename"].to_s %>" },
			<% end %>
		<% end %>
	<% end %>
	
	]
	,"/audio/");
	
	var queue = new createjs.LoadQueue();
	createjs.Sound.alternateExtensions = ["mp3"];
	queue.installPlugin(createjs.Sound);
	queue.addEventListener("fileload", handleFileLoad);
	queue.addEventListener("complete", handleComplete);
	
	
	queue.loadManifest([
		<% @riddles["scenarios"].each do |scenario| %>
			<% scenario["audio"].each do |audio| %>
				<% unless audio[1]["filename"].blank? %>
					{ id: "<%= scenario["bot"].to_s + "_" + audio[0].to_s %>", src: "/audio/<%= audio[1]["filename"].to_s %>" },
				<% end %>
			<% end %>
		<% end %>
	]);
	
	function handleFileLoad(event) {
		// A sound has been preloaded. This will fire TWICE
		console.log("Preloaded:", event.id, event.src);
	}
	function handleComplete(event) {
		// A sound has been preloaded. This will fire TWICE
		console.log("Preloading Complete");
		enableStart();
	}
	
	function enableStart() {
		$("#startBtn").fadeIn();
		$("#loadBar").fadeOut();
		
	}
	
	function fadeBtns() {
		$(".btn").fadeOut();
	}
	
	function fadeMain() {
		$("#mainScreen").fadeOut();
	}
	
	function mainScreen() {
		fadeBtns();
		$("#mainScreen").fadeIn();
	}
	
	function riddleBtn(parent) {
		$('#'+parent).children('.btn').fadeIn()
	}
	
	function loadScreen(name) {
		fadeMain();
		$('#'+name).fadeIn();
		riddleBtn(name);
	}
	function captureSound(callback) {
		var recognition = new webkitSpeechRecognition();
		recognition.lang = "en-US";
		recognition.onend = function (e) {
			if (callback) {
				callback('no results');
			}
		};
		recognition.onresult = function (e) {
            // cancel onend handler
            recognition.onend = null;
			
			console.log(e);
			console.log(e["results"][0][0]["transcript"]);
			$('#answer').text('Your Answer: ' + e["results"][0][0]["transcript"]);
			speechCapture = e["results"][0][0]["transcript"];
			
            if (callback) {
                callback(null, {
                    transcript: e.results[0][0].transcript,
                    confidence: e.results[0][0].confidence
                });
            }
        }
	
		recognition.start();
		
	}
	
	function captureSpeech() {
		captureSound('test', myCallBack);
		console.log('what?');
		alert('timing test');
	}
	
	function clearAnswer() {
		$('#answer').text('');
	}
	
	function submitAnswer(answer, bot) {
		var currentBot;
		for (i=0;i<main_obj.scenarios.length;i++) {
			if (bot == main_obj.scenarios[0].bot) {
				currentBot = main_obj.scenarios[0];
			}
		}
		
		console.log(currentBot);
		if (answer == speechCapture) {
			createjs.Sound.play(currentBot["bot"] + "_success");
			correctAnswers++;
			$('#'+bot).fadeOut();
			$('#'+bot+'_btn').css({ 'pointer-events': 'none' });
			mainScreen();
			clearAnswer()
			attempts = 0;
		} else if ( attempts < 3 ) {
			createjs.Sound.play(currentBot["bot"] + "_wrong");
			attempts++;
			console.log(attempts);
		} else {
			createjs.Sound.play(currentBot["bot"] + "_failure")
			$('#'+bot).fadeOut();
			$('#'+bot+'_btn').css({ 'pointer-events': 'none' });
			mainScreen();
			attempts = 0;
			clearAnswer()
		}
	}
	
</script>

<div id="container">
	<div id="loadBar">Loading this shit</div>
	<div id="answer"></div>
	<div id="startBtn" onclick="mainScreen()" class="btn">Fuckin start this shit</div>
	
	<div id="mainScreen" hidden>
		<% @riddles["scenarios"].each_with_index do |scenario, index| %>
			<div id="<%= scenario["bot"] %>_btn", class="bot" onclick="loadScreen('<%= scenario["bot"] %>')"><a href="#"><%= scenario["name"] %></a></div>
		<% end %>
		<div id="fridge"></div>
	</div>
	
	<div id="fridgeScreen">
	
	</div>	
	
	<!-- Riddle screens -->
	<% @riddles["scenarios"].each_with_index do |scenario, index| %>
		<div class="riddle_screen" id="<%= scenario["bot"] %>" hidden>
			<h1><%= scenario["name"] %></h1>
			<div class="riddle_btn btn">
				<%= link_to("Ask the Riddle!", "#", :onclick => 'createjs.Sound.play("' + scenario["bot"].to_s + '_riddle")') %>
			</div>
			<div class="riddle_btn btn">
				<%= link_to("Answer", "#", :onclick => 'captureSound()') %>
			</div>
			<div class="riddle_btn btn">
				<%= link_to("Submit", "#", :onclick => "submitAnswer('" + scenario["answers"][0].to_s + "', '" + scenario["bot"] + "' )") %>
			</div>
		</div>
	<% end %>
	
	
	
	
</div>


